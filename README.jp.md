# SaaS AuthN/Z Demo with Amazon Cognito

SaaS AuthN/Z Demo は SaaS プロダクトにおける AWS 上での認証 / 認可のコンセプトなどを解説し、Amazon Cognito で実現するためのサンプルアプリケーションです。

免責事項 : このアプリケーションは [SaaS AuthN/Z Workshop](https://catalog.us-east-1.prod.workshops.aws/workshops/9180bbda-7747-4b8f-ac05-14e7f258fcea) の中で利用されることを前提とした学習用のコンテンツであり、Amazon Cognito や Amazon Verified Permissions の機能や SaaS でのデザインパターンを学習することを目的としています。本番運用での利用は想定していないため、本レポジトリのコード・アセットの一部を自社プロダクトにご活用いただく場合は事前に十分な検討を実施してください。

## 目次
* [コンセプト](#コンセプト)
* [デプロイ方法](#デプロイ方法)
* [アーキテクチャ](#アーキテクチャ)
* [シナリオ](#シナリオ)
  * [オンボーディング処理の実行](/docs/onboarding.md)
  * [テナントへのサインイン](/docs/sign-in.md)
  * [テナントおよびユーザーの管理](/docs/manage-tenant-and-users.md)
    * [JWT の属性を用いた認可](/docs/authorize.md)
    * [外部 IdP を用いたサインインの詳細](/docs/federation-signin.md)
* [環境の削除](#環境の削除)
* その他
  * [テナントサービスの詳細](/docs/tenant-service.md)
  * [Amazon Cognito でのマルチテナント戦略](/docs/cognito-multi-tenancy.md)

## コンセプト

B2B SaaS アプリケーションの認証・認可の実装においては、通常の Web アプリケーションの認証・認可に比べて追加の考慮事項が必要となります。例えば、利用企業側のセキュリティポリシーに応じて、認証のオプションの提供が求められることがあったり、テナントの管理者が他のユーザーを管理する機能が必要になります。バックエンドアプリケーションではテナント分離や契約プラン、ユーザーロールなどの複数の要素に基づいてアクセス制御を行う必要があります。各種データベースやマイクロサービスに点在する認可のための情報をどのように効率的に取り扱うかも考えなければいけません。

![AccessPattern](/docs/images/saas-access-control-pattern.png)

アクセス制御においては、[こちらの記事](https://aws.amazon.com/jp/builders-flash/202108/saas-authorization-implementation-pattern/) で紹介している通り、各種 IdP やデータベースなどに点在しているこれらの情報を最初に JSON Web Token (JWT) に含んだ上でバックエンドに送ることで、バックエンド側の認可処理をシンプルに実現することができます。

本サンプルアプリケーションではこれらの SaaS での認証のコンセプトについて、Amazon Cognito や Amazon Verified Permissions でどのように実装していくのかの一例を示します。

## デプロイ方法

[デプロイ方法](/docs/how-to-deploy.md)の手順にしたがってデプロイしてください。

## アーキテクチャ

![Architecture](/docs/images/architecture.png)

|サービス名|説明|
|--|--|
|テナントサービス|SaaS の認証やテナント管理に関わるコア機能を司るマイクロサービスです。本デモアプリケーションに存在するテナントサービスの詳細については[こちら](/docs/tenant-service.md)をご参照ください。|
|アイデンティティサービス<br> (Amazon Cognito)|ユーザーの認証とテナントとの紐付けの機能を提供します。本アプリケーションではテナントごとにアプリケーションクライアントを割り当てる実装を採用しており、メールアドレスとパスワードを利用した認証とテナントごとの外部 IdP を利用した認証をサポートしています。<br>**備考 :** 一つのユーザープール内では、[リソースクォータ](https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/limits.html#resource-quotas)に記載がある通り、アプリクライアント数やアイデンティティプロバイダ数の上限が定まっています。デモアプリケーションでは、テナント数がリソースクォータに制約されないように、ユーザープールあたりの外部アイデンティティプロバイダ数のデフォルトクォータである 300 テナントごとに新たなユーザープールが作成されます。詳細については [Amazon Cognito でのマルチテナンシー](/docs/cognito-multi-tenancy.md)をご参照ください。|
|フロントエンドアプリケーション|認証画面やユーザーの管理画面を提供するフロントエンドアプリケーションです。認証やユーザー・テナント管理のためのAPIおよび画面を提供しています。ユーザー・テナント管理APIは認証済みユーザーのトークンを検証した上で、ユーザーの権限に応じてバックエンドのテナントサービスを呼び出します。本デモアプリケーションでは、Amazon API Gateway の AWS サービス統合とマッピングテンプレートを用いて、リクエストしたユーザーの所属するテナントにスコープを絞った上で直接テナントサービスを呼び出しています。|

## シナリオ

デモアプリケーションは以下のシナリオを想定しています。

1. SaaS 事業者のオペレーターがテナントの環境とテナント内の管理者ユーザーを追加します。
2. テナントサービスはアイデンティティサービスである Amazon Cognito に管理者ユーザーを追加します。
3. テナントの管理者ユーザーは Amazon Cognito から招待メールを受け取ります。
4. テナントの管理者ユーザーは招待メールに記載された URL にアクセスし、フロントエンドアプリケーションのログイン用フォームが表示されます。この時、テナントごとにどのユーザープールやアプリケーションクライアントを利用するかの情報を取得します。
5. テナントの管理者ユーザーは Amazon Cognito に対し、認証を行い、トークンを取得します。
6. サインインに成功すると、フロントエンドアプリケーションは、取得したトークンを付与して API を呼び出します。
7. サインインしたユーザーが要求された API 呼び出しを許可されているかを Lambda Authorizer と Amazon Verified Permissions で検証します。
8. API 呼び出しが許可されていれば、API Gateway はテナントにスコープを絞った上でバックエンドのサービスを呼び出します。本アプリケーションでは、API Gateway からテナントサービスに対して直接リクエストを行っていますが、API Gateway の後段に配置された Lambda 関数がコントロールプレーンのコアサービスを呼び出すことも一般的です。

各フェーズでの技術的な詳細は以下のドキュメントをご参照ください。

* [**オンボーディング処理の実行**](/docs/onboarding.md) : 新規テナントおよびユーザーを追加します。上記アーキテクチャ図では (1) - (3) の処理が該当します。
* [**テナントへのサインイン**](/docs/sign-in.md) :  テナントのユーザーとしてアプリケーションにアクセスし、ユーザープールへのサインイン後、テナントコンテキストを含んだトークンを取得します。上記アーキテクチャ図では (4) - (5) の処理が該当します。
* [**テナントおよびユーザーの管理**](/docs/manage-tenant-and-users.md) : テナント内の管理者ユーザーとして、バックエンドのAPI呼び出しを行い、テナント内のユーザーの管理を行います。上記アーキテクチャ図では (6) - (8) の処理が該当します。
  * [**JWT の属性を用いた認可**](/docs/authorize.md) : トークンに埋め込まれたテナントやユーザーの属性を用いることで、許可された範囲のAPIのみが実行されるように制御を行います。
  * [**外部 IdP によるサインイン**](/docs/federation-signin.md) : テナントの独自の IdP でのサインインを追加します。

## 環境の削除

* `cdk destroy` コマンドによりスタックを削除してください
* デモアプリケーションによって作成されたユーザープールを削除してください
* 連携した外部 IdP の設定情報を削除してください

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## License

This library is licensed under the MIT-0 License. See the LICENSE file.

